<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        html,
        body {
            height: 100%;
            box-sizing: border-box;
            user-select: none;
        }

        main {
            position: relative;
            width: 100%;
            height: 100%;
        }

        product-viewer {
            display: block;
            position: relative;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        drag-proxy {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 1px;
            height: 1px;
        }

        image-rotator {
            position: absolute;
            top: 50%;
            left: 50%;
            display: block;
            padding: 0;
            margin: 0;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        image-rotator canvas {
            display: block;
            padding: 0;
            margin: 0;
        }
    </style>
</head>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.5/angular.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.4/TweenMax.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.18.4/utils/Draggable.min.js"></script>
    <script src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/16327/ThrowPropsPlugin.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/3.0.11/pixi.js"></script>

    <main ng-app="app" ng-cloak>

        <product-viewer ng-if="imagesLoaded"></product-viewer>

        <script type="text/ng-template" id="product-viewer.html">
            <image-rotator image="mario" rotation="$ctrl.rotation"></image-rotator>    
            <drag-proxy></drag-proxy>    
        </script>

    </main>
    <script>
        var __extends = (this && this.__extends) || (function () {
            var extendStatics = function (d, b) {
                extendStatics = Object.setPrototypeOf ||
                    ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
                    function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };
                return extendStatics(d, b);
            };
            return function (d, b) {
                if (typeof b !== "function" && b !== null)
                    throw new TypeError("Class extends value " + String(b) + " is not a constructor or null");
                extendStatics(d, b);
                function __() { this.constructor = d; }
                d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
            };
        })();
        var App;
        (function (App) {
            console.clear();
            var baseURL = "https://s3-us-west-2.amazonaws.com/s.cdpn.io/106114/";
            var loader = new PIXI.loaders.Loader(baseURL);
            var spriteSheets = {
                mario: {
                    prefix: "img",
                    type: ".png",
                    data: [
                        { file: "mario2.json", size: 10 },
                        { file: "mario3.json", size: 10 },
                    ]
                }
            };
            //
            // IMAGE ROTATOR
            // ===========================================================================
            var ImageRotator = {
                bindings: {
                    rotation: "<",
                    image: "@"
                },
                controller: /** @class */ (function () {
                    function class_1($element, $window, textures) {
                        var _this = this;
                        this.$element = $element;
                        this.$window = $window;
                        this.textures = textures;
                        this.dirty = true;
                        this.ready = false;
                        this.total = 0;
                        this.width = 0;
                        this.height = 0;
                        this.stage = new PIXI.Container();
                        this.sprite = null;
                        this.renderer = null;
                        $window.addEventListener("resize", function () { return _this.dirty = true; });
                    }
                    class_1.prototype.$onChanges = function (changes) {
                        if (!this.ready)
                            return;
                        if (changes.rotation) {
                            this.setRotation(changes.rotation);
                        }
                    };
                    class_1.prototype.$postLink = function () {
                        var textures = this.textures[this.image];
                        var texture = textures[0];
                        this.total = textures.length;
                        this.width = texture.width;
                        this.height = texture.height;
                        this.renderer = PIXI.autoDetectRenderer(this.width, this.height, {
                            backgroundColor: 0xFFFFFF,
                        });
                        this.sprite = new ProductSprite(textures);
                        this.stage.addChild(this.sprite);
                        this.$element.append(this.renderer.view);
                        TweenLite.set(this.$element, { width: this.width, height: this.height });
                        TweenLite.ticker.addEventListener("tick", this.render, this);
                        this.ready = true;
                    };
                    class_1.prototype.setRotation = function (rotation) {
                        var total = this.total - 1;
                        var ratio = rotation.currentValue / 360;
                        var index = Math.round(ratio * total);
                        index = index < 1 ? total + index : index - 1;
                        this.sprite.frame = total - index;
                    };
                    class_1.prototype.resize = function () {
                        var vw = this.$window.innerWidth;
                        var vh = this.$window.innerHeight;
                        var scale = Math.min(Math.min(vw / this.width, vh / this.height), 1);
                        TweenLite.set(this.$element, { scale: scale });
                    };
                    class_1.prototype.render = function () {
                        if (this.dirty) {
                            this.resize();
                            this.dirty = false;
                        }
                        this.renderer.render(this.stage);
                    };
                    return class_1;
                }())
            };
            //
            // PRODUCT SPRITE
            // ===========================================================================
            var ProductSprite = /** @class */ (function (_super) {
                __extends(ProductSprite, _super);
                function ProductSprite(frames) {
                    var _this = _super.call(this, frames[0]) || this;
                    _this.frames = frames;
                    _this.total = _this.frames.length;
                    return _this;
                }
                Object.defineProperty(ProductSprite.prototype, "frame", {
                    set: function (n) { this.texture = this.frames[n % this.total]; },
                    enumerable: false,
                    configurable: true
                });
                return ProductSprite;
            }(PIXI.Sprite));
            //
            // DRAG PROXY
            // ===========================================================================
            var DragProxy = {
                require: { productViewer: "^productViewer" },
                controller: /** @class */ (function () {
                    function class_2($element) {
                        this.$element = $element;
                        this.lastX = 0;
                        this.lastY = 0;
                        this.rotation = 0;
                        this.transform = {};
                        this.draggable = null;
                    }
                    Object.defineProperty(class_2.prototype, "x", {
                        get: function () { return this.transform.x; },
                        enumerable: false,
                        configurable: true
                    });
                    Object.defineProperty(class_2.prototype, "y", {
                        get: function () { return this.transform.y; },
                        enumerable: false,
                        configurable: true
                    });
                    class_2.prototype.$postLink = function () {
                        var parent = this.productViewer.$element;
                        this.draggable = new Draggable(this.$element, {
                            // bounds: parent,
                            callbackScope: this,
                            cursor: "ew-resize",
                            maxDuration: 0.65,
                            // overshootTolerance: 0,
                            onDrag: this.updateRotation,
                            onDragStart: this.updatePosition,
                            onThrowUpdate: this.updateRotation,
                            throwProps: true,
                            trigger: parent
                        });
                        this.transform = this.$element[0]._gsTransform;
                    };
                    class_2.prototype.updatePosition = function () {
                        TweenLite.killTweensOf(this.$element);
                        var x = this.lastX = this.draggable.pointerX;
                        var y = this.lastY = this.draggable.pointerY;
                        TweenLite.set(this.$element, { x: x, y: y });
                        this.draggable.update();
                    };
                    class_2.prototype.updateRotation = function () {
                        var x = this.x;
                        var y = this.y;
                        var dx = x - this.lastX;
                        var dy = y - this.lastY;
                        this.lastX = x;
                        this.lastY = y;
                        this.rotation += dx;
                        this.productViewer.updateRotation(this.rotation % 360);
                    };
                    return class_2;
                }())
            };
            //
            // PRODUCT VIEWER
            // ===========================================================================
            var ProductViewer = {
                templateUrl: "product-viewer.html",
                controller: /** @class */ (function () {
                    function class_3($element, $scope) {
                        this.$element = $element;
                        this.$scope = $scope;
                        this.rotation = 0;
                    }
                    class_3.prototype.updateRotation = function (rotation) {
                        var _this = this;
                        this.$scope.$apply(function () { return _this.rotation = rotation; });
                    };
                    return class_3;
                }())
            };
            //
            // LOAD ASSETS
            // ===========================================================================
            function loadAssets($rootScope, loader, spriteSheets, textures) {
                angular.forEach(spriteSheets, function (spriteSheet) {
                    spriteSheet.data.forEach(function (data) { return loader.add(data.file); });
                });
                loader.load(function () {
                    angular.forEach(spriteSheets, function (spriteSheet, name) {
                        var count = 1;
                        textures[name] = spriteSheet.data.reduce(function (frames, data) {
                            for (var i = 0; i < data.size; i++) {
                                var index = i + count;
                                if (index < 10)
                                    index = "0" + index;
                                var frame = "".concat(spriteSheet.prefix).concat(index).concat(spriteSheet.type);
                                frames.push(PIXI.Texture.fromFrame(frame));
                            }
                            count = data.size;
                            return frames;
                        }, []);
                    });
                    $rootScope.$apply(function () { return ($rootScope.imagesLoaded = true); });
                });
            }
            //
            // MODULE
            // ===========================================================================
            angular
                .module("app", [])
                .run(loadAssets)
                .constant("loader", loader)
                .constant("spriteSheets", spriteSheets)
                .value("textures", {})
                .component("imageRotator", ImageRotator)
                .component("productViewer", ProductViewer)
                .component("dragProxy", DragProxy);
        })(App || (App = {}));

    </script>
</body>

</html>